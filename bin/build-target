#!/usr/bin/env bash

if [ -z "$1" ] || [ -z "$2" ]; then
  echo "usage: $0 [directory] [cmake target]"
  exit 1
fi

DIRECTORY="$PWD/$1"
BUILD_DIRECTORY="$PWD/cmake-build-$1"
USER_ID=$(id -u)

if [ ! -d "$DIRECTORY" ]; then
  echo "directory '$1' does not exist"
  exit 1
fi

mkdir -p "$BUILD_DIRECTORY"

docker run -t -i \
  --user "$USER_ID" \
  -v /etc/passwd:/etc/passwd:ro \
  -v /etc/group:/etc/group:ro \
  -v ${DIRECTORY}:/app/src \
  -v ${BUILD_DIRECTORY}:/app/build \
  cmake-builder \
  $2
